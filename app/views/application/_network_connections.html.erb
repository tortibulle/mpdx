<div class="network_connections">
  <% current_user.send("#{provider}_accounts".to_sym).each do |account| %>
      <div class="account_single <%= 'error_element' if account.try(:valid_credentials) == false %>"
           data-behavior="account" id="<%= provider%>-account-<%= account.id %>">
        <div class="actions">
          <% if provider == 'organization' %>
              <%= link_to(_('edit'), edit_person_organization_account_path(account, format: :js), class: "edit ico ico_edit no-new-tab",
                          data: {behavior: "edit_#{provider}_account"}) %>
          <% else %>
              <%= link_to(_('delete'), account_path(account, provider: provider), method: :delete, :class => "inlineaction delete",
                          data: { confirm: _('Are you sure you want to remove this connection?') }) %>
          <% end %>
        </div>
        <span class="account_name"><%= account %></span>

        <% case provider %>
        <% when 'google' %>
            <% if $rollout.active?(:google_integration, current_account_list) %>
                <% account.google_integration(current_account_list).tap do |google_integration| %>
                    <% if account.token_expired? && !account.refresh_token!  %>
                        <p><%= _('The link between MPDX and your Google account stopped working. Click "Refresh Google Account" to re-enable it.
                                     After that, you\'ll need to manually re-enable any integrations that you had set already.') %></p>
                        <% new_account_path_opts = { provider: :google } %>
                        <% new_account_path_opts[:redirect] =  google_integration_path(google_integration) if google_integration %>
                        <%= link_to(_('Refresh Google Account'), new_account_path(new_account_path_opts), class: 'btn desired_action') %>
                    <% else %>
                        <% if google_integration %>
                            <%= link_to(_('Configure synchronization'), google_integration_path(google_integration), class: 'btn smallbtn') %>
                        <% else %>
                            <%= link_to(_('Configure synchronization'), google_integrations_path(google_account_id: account.id), method: :post, class: 'btn smallbtn') %>
                        <% end %>
                         <%= render('google_import_options', account: account) if $rollout.active?(:google_contacts_import, current_account_list) %>
                     <% end %>
                <% end %>
            <% end %>

        <% when 'facebook' %>
            <% if account.downloading? %>
                <%= _('Contacts are currently being imported') %>
            <% else %>
                <div class="importoptions formstyles" data-behavior="import_options" style="display:none">
                  <%= form_for Import.new(source: provider, source_account_id: account.id) do |f| %>
                      <%= f.hidden_field :source %>
                      <%= f.hidden_field :source_account_id %>
                      <div class="importtags">
                        <%= f.text_field :tags, placeholder: _('Add tags to these contacts') %>
                      </div>
                      <a href="#" class="btn btngreen" data-behavior="import_button"><%= _('Import') %></a>
                  <% end %>
                </div>
                <div><a href="#" class="btn smallbtn" data-behavior="show_import"><%= _('Import Contacts') %></a></div>
            <% end %>

        <% end %>

      </div>
  <% end %>
</div>